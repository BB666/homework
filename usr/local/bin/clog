#!/bin/sh

# Clog RabbitMQ queue to make an alarm on Zabbix server
# Default threshold on Zabbix server is set to 10 messages
# We will try to clog queue with 15 messages where consumers are trying to make queue empty

let NUM=0
let PAYLOAD=1
# exit if 50 attempts to clog the queue are unsuccessful
while [ $NUM -le 15 ] && [ $PAYLOAD -le 50 ]; do
    NUM=`sudo rabbitmqctl list_queues name messages_ready | grep 'central' |  awk '{ print $2 }'`
	/usr/local/bin/app-server $PAYLOAD
    # increase sleep time for consumers with each iteration
    let PAYLOAD=$PAYLOAD+1
done
